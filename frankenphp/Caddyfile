{
    order php_server before file_server
    auto_https off  # Désactive HTTPS car Railway le gère
    log {
        output stdout
        level DEBUG
    }
}

{$SERVER_NAME:localhost} {
    root * /app/public
    encode zstd br gzip

    # Détecte si la requête arrive en HTTPS via le proxy Railway
    @is_https {
        header X-Forwarded-Proto https
    }
    # Redirige HTTP → HTTPS uniquement si la requête ne vient pas du proxy
    @needs_https {
        not header X-Forwarded-Proto https
    }
    redir @needs_https https://{host}{uri} permanent

    # Configure FrankenPHP pour Symfony
    php_server {
        root /app/public  # Point d'entrée de Symfony
        split .php
        env PATH /usr/local/bin:/usr/bin:/bin
        resolve_root_symlink  # Gère les liens symboliques
    }

    # Headers de sécurité
    header ?Permissions-Policy "browsing-topics=()"
    header ?Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
}